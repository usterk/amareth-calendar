<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amaréth Calendar — Astro</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #06060f;
            --surface: #0e0e1e;
            --surface-alt: #141428;
            --border: #252545;
            --border-glow: #3a3a6a;
            --text: #ddd6f0;
            --text-muted: #7a7498;
            --accent: #c8a84e;
            --accent-dim: #c8a84e22;
            --accent-glow: #c8a84e55;
            --glow: #6a4fd4;
            --glow-light: #9b7aff;
            --warning: #f85149;
            --warning-bg: #f8514922;

            --fire: #d4603a;
            --earth: #5a9a40;
            --air: #d4c44a;
            --water: #4058a8;

            --sun: #f0c040;
            --moon: #c8d0e8;
            --mars: #d44040;
            --mercury: #a080d0;
            --jupiter: #4080d0;
            --venus: #40b880;
            --saturn: #808080;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Raleway', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 1.5rem;
            position: relative;
            overflow-x: hidden;
        }

        /* ===== STARFIELD ===== */
        .starfield {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none;
            background: radial-gradient(ellipse at 50% 40%, #0d0d28 0%, #060614 60%, #020208 100%);
        }
        .starfield::before, .starfield::after, .stars-3 {
            content: ''; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; pointer-events: none;
        }
        .starfield::before {
            background-image:
                radial-gradient(1px 1px at 10% 20%, #fff8 0%, transparent 100%),
                radial-gradient(1px 1px at 25% 35%, #fff6 0%, transparent 100%),
                radial-gradient(1px 1px at 40% 15%, #fff5 0%, transparent 100%),
                radial-gradient(1px 1px at 55% 45%, #fff7 0%, transparent 100%),
                radial-gradient(1px 1px at 70% 25%, #fff4 0%, transparent 100%),
                radial-gradient(1px 1px at 85% 60%, #fff6 0%, transparent 100%),
                radial-gradient(1px 1px at 15% 70%, #fff5 0%, transparent 100%),
                radial-gradient(1px 1px at 30% 80%, #fff7 0%, transparent 100%),
                radial-gradient(1px 1px at 50% 65%, #fff4 0%, transparent 100%),
                radial-gradient(1px 1px at 65% 75%, #fff6 0%, transparent 100%),
                radial-gradient(1px 1px at 80% 40%, #fff5 0%, transparent 100%),
                radial-gradient(1px 1px at 95% 10%, #fff7 0%, transparent 100%),
                radial-gradient(1px 1px at 5% 50%, #fff4 0%, transparent 100%),
                radial-gradient(1px 1px at 20% 90%, #fff6 0%, transparent 100%),
                radial-gradient(1px 1px at 45% 30%, #fff5 0%, transparent 100%),
                radial-gradient(1px 1px at 60% 55%, #fff3 0%, transparent 100%),
                radial-gradient(1px 1px at 75% 85%, #fff6 0%, transparent 100%),
                radial-gradient(1px 1px at 90% 70%, #fff4 0%, transparent 100%),
                radial-gradient(1.5px 1.5px at 35% 50%, #ffd8 0%, transparent 100%),
                radial-gradient(1.5px 1.5px at 88% 22%, #ffd6 0%, transparent 100%);
            animation: twinkle1 4s ease-in-out infinite alternate;
        }
        .starfield::after {
            background-image:
                radial-gradient(1px 1px at 8% 12%, #ccf4 0%, transparent 100%),
                radial-gradient(1px 1px at 22% 28%, #ccf3 0%, transparent 100%),
                radial-gradient(1px 1px at 38% 8%, #ccf5 0%, transparent 100%),
                radial-gradient(1px 1px at 52% 38%, #ccf4 0%, transparent 100%),
                radial-gradient(1px 1px at 68% 18%, #ccf3 0%, transparent 100%),
                radial-gradient(1px 1px at 82% 52%, #ccf5 0%, transparent 100%),
                radial-gradient(1px 1px at 12% 62%, #ccf4 0%, transparent 100%),
                radial-gradient(1px 1px at 28% 72%, #ccf3 0%, transparent 100%),
                radial-gradient(1px 1px at 48% 58%, #ccf5 0%, transparent 100%),
                radial-gradient(1px 1px at 62% 68%, #ccf4 0%, transparent 100%),
                radial-gradient(1px 1px at 78% 32%, #ccf3 0%, transparent 100%),
                radial-gradient(1px 1px at 92% 82%, #ccf5 0%, transparent 100%),
                radial-gradient(1px 1px at 3% 42%, #ccf4 0%, transparent 100%),
                radial-gradient(1px 1px at 18% 82%, #ccf3 0%, transparent 100%),
                radial-gradient(1px 1px at 42% 22%, #ccf5 0%, transparent 100%),
                radial-gradient(2px 2px at 58% 48%, #c8a84e44 0%, transparent 100%),
                radial-gradient(2px 2px at 73% 78%, #ff880033 0%, transparent 100%);
            animation: twinkle2 5s ease-in-out infinite alternate;
        }
        @keyframes twinkle1 { 0% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes twinkle2 { 0% { opacity: 1; } 100% { opacity: 0.5; } }

        /* ===== HEADER ===== */
        .header { text-align: center; margin-bottom: 1.5rem; }
        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2rem; font-weight: 700;
            letter-spacing: 0.15em;
            background: linear-gradient(135deg, #c8a84e, #e8d88e, #c8a84e);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.2rem;
        }
        .header .subtitle {
            font-family: 'Cinzel', serif;
            color: var(--text-muted); font-size: 0.8rem;
            letter-spacing: 0.3em; text-transform: uppercase;
            margin-bottom: 0.6rem;
        }
        .theme-nav { display: flex; justify-content: center; gap: 0.25rem; }
        .theme-nav .theme-active, .theme-nav .theme-link {
            padding: 0.3rem 0.75rem; border-radius: 20px; font-size: 0.8rem; text-decoration: none;
            font-family: 'Raleway', sans-serif;
        }
        .theme-nav .theme-active {
            background: linear-gradient(135deg, #6a4fd4, #9b7aff);
            color: #fff; font-weight: 600;
        }
        .theme-nav .theme-link {
            border: 1px solid var(--border); color: var(--text-muted);
        }
        .theme-nav .theme-link:hover { border-color: var(--accent); color: var(--text); }

        /* ===== LOCATION BAR ===== */
        .location-bar {
            max-width: 600px;
            margin: 0 auto 1.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
        }
        .location-bar .loc-row {
            display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;
        }
        .location-bar button {
            background: linear-gradient(135deg, var(--glow), var(--glow-light));
            border: none; color: #fff;
            padding: 0.45rem 0.8rem; border-radius: 6px;
            cursor: pointer; font-size: 0.85rem; font-weight: 600; white-space: nowrap;
        }
        .location-bar button:hover { opacity: 0.9; }
        .location-bar button.secondary {
            background: var(--surface-alt);
            border: 1px solid var(--border); color: var(--text);
        }
        .location-bar input {
            background: var(--bg); border: 1px solid var(--border);
            color: var(--text); padding: 0.45rem 0.6rem;
            border-radius: 6px; font-size: 0.85rem; width: 90px;
        }
        .location-bar select {
            background: var(--bg); border: 1px solid var(--border);
            color: var(--text); padding: 0.45rem 0.6rem;
            border-radius: 6px; font-size: 0.85rem; flex: 1; min-width: 160px;
        }
        .location-bar select optgroup { color: var(--accent); }
        .location-bar select option { color: var(--text); background: var(--bg); }
        .location-bar .loc-label { color: var(--text-muted); font-size: 0.8rem; }
        .location-bar .loc-status { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem; }

        /* ===== POLAR WARNING ===== */
        .polar-warning {
            max-width: 600px; margin: 0 auto 1.5rem;
            background: var(--warning-bg); border: 1px solid var(--warning);
            border-radius: 10px; padding: 1.2rem; text-align: center;
        }
        .polar-warning .pw-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .polar-warning .pw-title { font-weight: 600; margin-bottom: 0.25rem; }
        .polar-warning .pw-detail { color: var(--text-muted); font-size: 0.85rem; }

        /* ===== MAIN LAYOUT ===== */
        .main-display {
            max-width: 900px; margin: 0 auto 2rem;
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 1.5rem; align-items: start;
        }
        @media (max-width: 700px) {
            .main-display { grid-template-columns: 1fr; }
        }

        /* ===== ZODIAC WHEEL ===== */
        .wheel-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem;
            min-height: 300px;
        }
        .wheel-container svg { width: 100%; max-width: 420px; height: auto; display: block; margin: 0 auto; }

        /* ===== TODAY PANEL ===== */
        .today-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
        }
        .today-panel .sign-symbol {
            font-size: 4rem; display: block; text-align: center;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 30px var(--accent-glow), 0 0 60px var(--accent-dim);
        }
        .today-panel .zodiac-date {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem; font-weight: 600;
            text-align: center; margin-bottom: 0.15rem;
            color: var(--accent);
        }
        .today-panel .gregorian-date {
            text-align: center; color: var(--text-muted);
            font-size: 0.85rem; margin-bottom: 1rem;
        }
        .today-panel .sign-badges {
            display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 1rem;
        }
        .today-panel .badge {
            padding: 0.2rem 0.6rem; border-radius: 12px;
            font-size: 0.75rem; font-weight: 600;
            border: 1px solid;
        }
        .badge-fire { border-color: var(--fire); color: var(--fire); }
        .badge-earth { border-color: var(--earth); color: var(--earth); }
        .badge-air { border-color: var(--air); color: var(--air); }
        .badge-water { border-color: var(--water); color: var(--water); }
        .today-panel .sun-position {
            text-align: center; font-size: 0.9rem;
            color: var(--text-muted); margin-bottom: 0.75rem;
        }
        .today-panel .sun-times-row {
            display: flex; justify-content: center; gap: 2rem;
            font-size: 0.85rem; color: var(--text-muted);
        }
        .today-panel .current-hour-info {
            margin-top: 1rem; padding-top: 1rem;
            border-top: 1px solid var(--border);
            text-align: center;
        }
        .today-panel .hour-planet-symbol {
            font-size: 2rem; display: block; margin-bottom: 0.25rem;
        }
        .today-panel .hour-planet-name {
            font-family: 'Cinzel', serif;
            font-size: 1rem; font-weight: 600;
        }
        .today-panel .hour-time {
            font-size: 0.8rem; color: var(--text-muted);
        }

        /* ===== YEAR NAV ===== */
        .year-nav {
            display: flex; align-items: center; justify-content: center;
            gap: 1rem; margin-bottom: 1rem;
        }
        .year-nav button {
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text); padding: 0.5rem 1rem; border-radius: 6px;
            cursor: pointer; font-size: 1rem;
        }
        .year-nav button:hover { border-color: var(--glow-light); }
        .year-nav .year-label {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem; font-weight: 600;
            min-width: 120px; text-align: center;
            color: var(--accent);
        }
        .year-summary {
            text-align: center; color: var(--text-muted);
            margin-bottom: 1.5rem; font-size: 0.9rem;
        }

        /* ===== MONTH CARDS ===== */
        .months-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem; max-width: 1200px; margin: 0 auto;
        }
        .month-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 1rem; transition: border-color 0.3s;
            border-left: 3px solid var(--border);
        }
        .month-card:hover { border-color: var(--border-glow); }
        .month-card.current {
            border-color: var(--accent);
            border-left-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-dim), inset 0 0 20px var(--accent-dim);
            animation: currentGlow 3s ease-in-out infinite alternate;
        }
        @keyframes currentGlow {
            0% { box-shadow: 0 0 15px var(--accent-dim), inset 0 0 15px #c8a84e11; }
            100% { box-shadow: 0 0 25px var(--accent-glow), inset 0 0 25px #c8a84e22; }
        }
        .month-card.fire { border-left-color: var(--fire); }
        .month-card.earth { border-left-color: var(--earth); }
        .month-card.air { border-left-color: var(--air); }
        .month-card.water { border-left-color: var(--water); }
        .month-header {
            display: flex; align-items: center; gap: 0.5rem;
            margin-bottom: 0.75rem; padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        .month-header .symbol {
            font-size: 1.8rem;
            text-shadow: 0 0 15px var(--glow);
        }
        .month-header .name {
            font-family: 'Cinzel', serif;
            font-weight: 600; font-size: 1.1rem; flex: 1;
        }
        .month-header .days-badge {
            background: var(--accent-dim); color: var(--accent);
            padding: 0.15rem 0.5rem; border-radius: 10px;
            font-size: 0.75rem; font-weight: 600;
        }
        .month-info {
            display: flex; justify-content: space-between;
            color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.5rem;
        }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day-label {
            text-align: center; font-size: 0.65rem;
            color: var(--text-muted); padding: 2px 0; font-weight: 600;
        }
        .day-cell {
            text-align: center; padding: 3px 0; font-size: 0.8rem;
            border-radius: 4px; color: var(--text-muted);
        }
        .day-cell.today {
            background: linear-gradient(135deg, var(--glow), var(--glow-light));
            color: #fff; font-weight: 700;
        }
        .day-cell.empty { visibility: hidden; }

        /* ===== CONVERTER ===== */
        .converter {
            max-width: 500px; margin: 2rem auto 0;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 1.5rem;
        }
        .converter h3 {
            font-family: 'Cinzel', serif;
            margin-bottom: 1rem; font-size: 1rem;
        }
        .converter input {
            background: var(--bg); border: 1px solid var(--border);
            color: var(--text); padding: 0.5rem; border-radius: 6px;
            font-size: 1rem; width: 100%;
        }
        .converter .result {
            margin-top: 0.75rem; padding: 0.75rem;
            background: var(--bg); border-radius: 6px; font-size: 0.95rem;
        }
    </style>
</head>
<body>
    <div class="starfield"></div>

    <div class="header">
        <h1>Amaréth Calendar</h1>
        <div class="subtitle">Horae Temporales</div>
        <nav class="theme-nav">
            <a href="index.html" class="theme-link" id="classic-link">Klasyczny</a>
            <span class="theme-active">✦ Astro</span>
        </nav>
    </div>

    <div class="location-bar" id="location-bar">
        <div class="loc-row">
            <button onclick="requestGeolocation()">Moja lokalizacja</button>
            <span class="loc-label">lub:</span>
            <select id="city-select" onchange="selectCity(this.value)">
                <option value="">-- Wybierz miasto --</option>
                <optgroup label="Polska">
                    <option value="52.23,21.01">Warszawa</option>
                    <option value="50.06,19.94">Krakow</option>
                    <option value="51.11,17.04">Wroclaw</option>
                    <option value="54.35,18.65">Gdansk</option>
                    <option value="53.01,18.60">Torun</option>
                </optgroup>
                <optgroup label="Europa">
                    <option value="51.51,-0.13">Londyn</option>
                    <option value="48.86,2.35">Paryz</option>
                    <option value="52.52,13.41">Berlin</option>
                    <option value="41.90,12.50">Rzym</option>
                    <option value="40.42,-3.70">Madryt</option>
                    <option value="59.33,18.07">Sztokholm</option>
                    <option value="55.68,12.57">Kopenhaga</option>
                    <option value="60.17,24.94">Helsinki</option>
                    <option value="38.72,-9.14">Lizbona</option>
                    <option value="37.98,23.73">Ateny</option>
                    <option value="50.45,30.52">Kijow</option>
                    <option value="55.76,37.62">Moskwa</option>
                    <option value="41.01,28.98">Stambu&#322;</option>
                </optgroup>
                <optgroup label="Ameryka Pn.">
                    <option value="40.71,-74.01">Nowy Jork</option>
                    <option value="34.05,-118.24">Los Angeles</option>
                    <option value="41.88,-87.63">Chicago</option>
                    <option value="43.65,-79.38">Toronto</option>
                    <option value="19.43,-99.13">Meksyk</option>
                </optgroup>
                <optgroup label="Ameryka Pd.">
                    <option value="-23.55,-46.63">Sao Paulo</option>
                    <option value="-34.60,-58.38">Buenos Aires</option>
                    <option value="-12.05,-77.04">Lima</option>
                    <option value="4.71,-74.07">Bogota</option>
                </optgroup>
                <optgroup label="Azja">
                    <option value="35.68,139.69">Tokio</option>
                    <option value="37.57,126.98">Seul</option>
                    <option value="39.90,116.40">Pekin</option>
                    <option value="31.23,121.47">Szanghaj</option>
                    <option value="22.32,114.17">Hongkong</option>
                    <option value="1.35,103.82">Singapur</option>
                    <option value="13.76,100.50">Bangkok</option>
                    <option value="28.61,77.21">Delhi</option>
                    <option value="19.08,72.88">Mumbaj</option>
                    <option value="25.20,55.27">Dubaj</option>
                    <option value="31.77,35.23">Jerozolima</option>
                </optgroup>
                <optgroup label="Afryka">
                    <option value="30.04,31.24">Kair</option>
                    <option value="-33.93,18.42">Kapsztad</option>
                    <option value="-1.29,36.82">Nairobi</option>
                    <option value="6.52,3.38">Lagos</option>
                </optgroup>
                <optgroup label="Oceania">
                    <option value="-33.87,151.21">Sydney</option>
                    <option value="-36.85,174.76">Auckland</option>
                </optgroup>
                <optgroup label="Arktyka/Antarktyka">
                    <option value="78.22,15.64">Longyearbyen (Svalbard)</option>
                    <option value="64.14,-21.90">Reykjavik</option>
                    <option value="69.65,18.96">Tromso</option>
                </optgroup>
            </select>
        </div>
        <div class="loc-row" style="margin-top:0.4rem">
            <input type="number" id="lat-input" placeholder="szer. geog." step="0.01" min="-90" max="90">
            <input type="number" id="lng-input" placeholder="dl. geog." step="0.01" min="-180" max="180">
            <button class="secondary" onclick="setManualLocation()">Ustaw</button>
        </div>
        <div class="loc-status" id="loc-status">Podaj lokalizacje aby obliczyc godziny planetarne i wschody/zachody Slonca</div>
    </div>

    <div id="polar-warning" style="display:none"></div>

    <div class="main-display">
        <div class="wheel-container" id="wheel-container">
            <div style="color: var(--text-muted)">Obliczam...</div>
        </div>
        <div class="today-panel" id="today-panel">
            <div style="color: var(--text-muted); text-align:center">Obliczam pozycje astronomiczne...</div>
        </div>
    </div>

    <div class="year-nav">
        <button onclick="changeYear(-1)">&larr;</button>
        <div class="year-label" id="year-label"></div>
        <button onclick="changeYear(1)">&rarr;</button>
    </div>
    <div class="year-summary" id="year-summary"></div>
    <div class="months-grid" id="months-grid"></div>

    <div class="converter">
        <h3>Konwerter dat</h3>
        <input type="date" id="converter-input" onchange="convertDate(this.value)">
        <div class="result" id="converter-result">Wybierz date do konwersji</div>
    </div>

    <script>
        // Detect file:// protocol - ES modules require HTTP server
        if (window.location.protocol === 'file:') {
            document.getElementById('wheel-container').innerHTML =
                '<div style="color:#f85149;text-align:center;padding:2rem">ES modules wymagaja serwera HTTP.<br>Uruchom: <code>cd frontend && python3 -m http.server 8001</code><br>i otworz <code>http://localhost:8001/astro.html</code></div>';
        }
    </script>
    <script type="module">
        import {
            RAD, DAY_MS, ZODIAC, DAY_NAMES, CHALDEAN, DAY_RULER_IDX, AMARETH_EPOCH,
            ELEMENT_LABELS, MODALITY_LABELS,
            getSunTimes, julianDay, jdToDate, sunLongitude, findSunCrossing,
            getIngresses, truncToDate, effectiveMonthStart,
            getMonthStartDates, getMonthDays, gregorianToZodiac,
            getPlanetaryHours, toAmareth, fromAmareth, fmtAmarethYear, fmtTime,
        } from './engine.js';

        // SIGN_META is now part of ZODIAC in engine.js (element, modality, elColor)

        // ===== STATE =====
        let currentYear;
        let userLat = 53.01, userLng = 18.60;
        let polarState = null;

        const todayUTC = new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate()));
        const nowLocal = new Date();

        // Read location from URL params
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('lat') && urlParams.has('lng')) {
            const pLat = parseFloat(urlParams.get('lat'));
            const pLng = parseFloat(urlParams.get('lng'));
            if (!isNaN(pLat) && !isNaN(pLng)) { userLat = pLat; userLng = pLng; }
        }

        currentYear = gregorianToZodiac(todayUTC, userLat, userLng).year;

        // ===== ZODIAC WHEEL SVG =====
        function buildAstroWheel(hours, currentIdx, sunrise, sunset, dayHourMin, nightHourMin) {
            const W = 440, H = 440;
            const cx = W / 2, cy = H / 2;
            const R_ZODIAC_OUT = 210, R_ZODIAC_IN = 178;
            const R_HOUR_OUT = 175, R_HOUR_IN = 115;
            const R_SYM = 145;
            const R_ZODIAC_SYM = 194;
            const SEG_H = 15; // 360/24
            const GAP_H = 0.6;
            const now = Date.now();

            // Current sun longitude
            const jd = julianDay(nowLocal.getUTCFullYear(), nowLocal.getUTCMonth() + 1, nowLocal.getUTCDate(),
                nowLocal.getUTCHours() + nowLocal.getUTCMinutes() / 60);
            const sunLon = sunLongitude(jd);
            const currentSignIdx = Math.floor(sunLon / 30);

            function polar(r, deg) {
                const rad = (deg - 90) * Math.PI / 180;
                return [cx + r * Math.cos(rad), cy + r * Math.sin(rad)];
            }
            function wedge(r1, r2, a1, a2) {
                const [ox1,oy1] = polar(r2, a1), [ox2,oy2] = polar(r2, a2);
                const [ix2,iy2] = polar(r1, a2), [ix1,iy1] = polar(r1, a1);
                const lg = (a2 - a1) > 180 ? 1 : 0;
                return `M${ox1},${oy1} A${r2},${r2} 0 ${lg} 1 ${ox2},${oy2} L${ix2},${iy2} A${r1},${r1} 0 ${lg} 0 ${ix1},${iy1} Z`;
            }

            let s = `<svg viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-width:420px;height:auto;display:block;margin:0 auto;">`;

            // Defs
            s += `<defs>`;
            s += `<radialGradient id="aGlow" cx="50%" cy="50%"><stop offset="0%" stop-color="#6a4fd4" stop-opacity="0.08"/><stop offset="100%" stop-color="#6a4fd4" stop-opacity="0"/></radialGradient>`;
            s += `<filter id="goldGlow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>`;
            s += `<filter id="softGlow"><feGaussianBlur stdDeviation="1.2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>`;
            s += `</defs>`;

            // Background glow
            s += `<circle cx="${cx}" cy="${cy}" r="${R_ZODIAC_OUT + 10}" fill="url(#aGlow)"/>`;

            // ===== OUTER RING: 12 Zodiac Signs =====
            for (let i = 0; i < 12; i++) {
                const a1 = i * 30 + 0.4;
                const a2 = (i + 1) * 30 - 0.4;
                const isCurrent = i === currentSignIdx;
                const meta = ZODIAC[i];

                let fill, fOpacity;
                if (isCurrent) {
                    fill = "#c8a84e"; fOpacity = 0.18;
                } else {
                    fill = meta.elColor; fOpacity = 0.12;
                }

                s += `<path d="${wedge(R_ZODIAC_IN, R_ZODIAC_OUT, a1, a2)}" fill="${fill}" fill-opacity="${fOpacity}" stroke="${isCurrent ? '#c8a84e' : '#252545'}" stroke-width="${isCurrent ? 1.5 : 0.5}"${isCurrent ? ' filter="url(#goldGlow)"' : ''}/>`;

                // Sign symbol
                const mid = (a1 + a2) / 2;
                const [tx, ty] = polar(R_ZODIAC_SYM, mid);
                const tColor = isCurrent ? '#c8a84e' : meta.elColor;
                const tSize = isCurrent ? 17 : 14;
                s += `<text x="${tx}" y="${ty}" fill="${tColor}" font-size="${tSize}" text-anchor="middle" dominant-baseline="central" font-weight="${isCurrent ? 'bold' : 'normal'}"${isCurrent ? ' filter="url(#softGlow)"' : ''}>${ZODIAC[i].symbol}</text>`;

                // Tooltip
                s += `<circle cx="${tx}" cy="${ty}" r="13" fill="transparent"><title>${ZODIAC[i].name} (${ZODIAC[i].latin}) — ${ELEMENT_LABELS[meta.element]}, ${MODALITY_LABELS[meta.modality]}</title></circle>`;
            }

            // ===== MIDDLE RING: 24 Planetary Hours =====
            // Sunrise/sunset boundary lines
            const [sr1x, sr1y] = polar(R_HOUR_IN - 3, 0);
            const [sr2x, sr2y] = polar(R_HOUR_OUT + 2, 0);
            s += `<line x1="${sr1x}" y1="${sr1y}" x2="${sr2x}" y2="${sr2y}" stroke="#f0c040" stroke-width="1.5" opacity="0.4"/>`;
            const [ss1x, ss1y] = polar(R_HOUR_IN - 3, 180);
            const [ss2x, ss2y] = polar(R_HOUR_OUT + 2, 180);
            s += `<line x1="${ss1x}" y1="${ss1y}" x2="${ss2x}" y2="${ss2y}" stroke="#6080b0" stroke-width="1.5" opacity="0.4"/>`;

            if (hours) {
                for (let i = 0; i < 24; i++) {
                    const h = hours[i];
                    const a1 = i * SEG_H + GAP_H / 2;
                    const a2 = (i + 1) * SEG_H - GAP_H / 2;
                    const isDay = i < 12;
                    const isCurrent = i === currentIdx;
                    const isPast = now > h.end.getTime();

                    let fill, fOpacity, sW, sC;
                    if (isCurrent) {
                        fill = h.planet.hex; fOpacity = 0.25; sW = 1.5; sC = h.planet.hex;
                    } else {
                        fill = isDay ? '#f0c040' : '#304878';
                        fOpacity = isPast ? 0.05 : (isDay ? 0.12 : 0.18);
                        sW = 0.3; sC = '#252545';
                    }

                    s += `<path d="${wedge(R_HOUR_IN, R_HOUR_OUT, a1, a2)}" fill="${fill}" fill-opacity="${fOpacity}" stroke="${sC}" stroke-width="${sW}"${isCurrent ? ' filter="url(#softGlow)"' : ''}/>`;

                    // Planet symbol
                    const mid = (a1 + a2) / 2;
                    const [px, py] = polar(R_SYM, mid);
                    const pColor = isCurrent ? '#fff' : (isPast ? '#2a2a3a' : h.planet.hex);
                    const pSize = isCurrent ? 17 : 12;
                    s += `<text x="${px}" y="${py}" fill="${pColor}" font-size="${pSize}" text-anchor="middle" dominant-baseline="central" font-weight="${isCurrent ? 'bold' : 'normal'}">${h.planet.symbol}</text>`;

                    // Tooltip
                    s += `<circle cx="${px}" cy="${py}" r="10" fill="transparent"><title>${h.planet.name} ${fmtTime(h.start)}-${fmtTime(h.end)} (${Math.round(h.durationMin)} min)</title></circle>`;
                }

                // Clock hand
                if (currentIdx >= 0) {
                    const h = hours[currentIdx];
                    const progress = Math.min(1, (now - h.start.getTime()) / (h.end.getTime() - h.start.getTime()));
                    const handAngle = currentIdx * SEG_H + SEG_H * progress;
                    const [hsx, hsy] = polar(R_HOUR_IN + 5, handAngle);
                    const [hex, hey] = polar(R_HOUR_OUT - 3, handAngle);
                    s += `<line x1="${hsx}" y1="${hsy}" x2="${hex}" y2="${hey}" stroke="#fff" stroke-width="2.5" stroke-linecap="round" opacity="0.85"/>`;
                    s += `<circle cx="${hex}" cy="${hey}" r="4" fill="#fff" stroke="${h.planet.hex}" stroke-width="1.5" opacity="0.95"/>`;
                }
            }

            // ===== SUN POSITION INDICATOR =====
            const sunAngle = sunLon; // degrees, 0=Aries
            const [sunX, sunY] = polar(R_ZODIAC_IN + (R_ZODIAC_OUT - R_ZODIAC_IN) / 2, sunAngle);
            s += `<circle cx="${sunX}" cy="${sunY}" r="4" fill="#c8a84e" filter="url(#softGlow)" opacity="0.8"/>`;
            s += `<line x1="${cx}" y1="${cy}" x2="${sunX}" y2="${sunY}" stroke="#c8a84e" stroke-width="1" opacity="0.25" stroke-dasharray="3,3"/>`;

            // ===== CENTER =====
            const R_CENTER = R_HOUR_IN - 6;
            s += `<circle cx="${cx}" cy="${cy}" r="${R_CENTER}" fill="#0a0a18" stroke="#252545" stroke-width="0.5"/>`;

            if (hours && currentIdx >= 0) {
                const h = hours[currentIdx];
                const remaining = Math.max(0, Math.round((h.end.getTime() - now) / 60000));
                const progress = Math.min(1, (now - h.start.getTime()) / (h.end.getTime() - h.start.getTime()));

                // Minutes progress arc (fills clockwise as hour progresses)
                const R_ARC = R_CENTER - 3;
                const arcAngle = progress * 360;
                if (arcAngle > 0.5) {
                    const startA = -90; // top
                    const endA = startA + arcAngle;
                    const startRad = startA * Math.PI / 180;
                    const endRad = endA * Math.PI / 180;
                    const x1 = cx + R_ARC * Math.cos(startRad);
                    const y1 = cy + R_ARC * Math.sin(startRad);
                    const x2 = cx + R_ARC * Math.cos(endRad);
                    const y2 = cy + R_ARC * Math.sin(endRad);
                    const largeArc = arcAngle > 180 ? 1 : 0;
                    s += `<path d="M${x1},${y1} A${R_ARC},${R_ARC} 0 ${largeArc} 1 ${x2},${y2}" fill="none" stroke="${h.planet.hex}" stroke-width="2.5" opacity="0.4" stroke-linecap="round"/>`;
                }

                // Minutes hand (one full rotation per planetary hour)
                const minuteAngle = progress * 360 - 90; // -90 to start from top
                const minuteRad = minuteAngle * Math.PI / 180;
                const R_MIN_HAND = R_CENTER - 14;
                const mhx = cx + R_MIN_HAND * Math.cos(minuteRad);
                const mhy = cy + R_MIN_HAND * Math.sin(minuteRad);
                s += `<line x1="${cx}" y1="${cy}" x2="${mhx}" y2="${mhy}" stroke="${h.planet.hex}" stroke-width="1.5" opacity="0.6" stroke-linecap="round"/>`;
                s += `<circle cx="${mhx}" cy="${mhy}" r="2.5" fill="${h.planet.hex}" opacity="0.7"/>`;
                s += `<circle cx="${cx}" cy="${cy}" r="3" fill="#0a0a18" stroke="${h.planet.hex}" stroke-width="1" opacity="0.5"/>`;

                // Minute tick marks (12 ticks around inner circle)
                for (let t = 0; t < 12; t++) {
                    const tickA = (t * 30 - 90) * Math.PI / 180;
                    const t1x = cx + (R_CENTER - 1) * Math.cos(tickA);
                    const t1y = cy + (R_CENTER - 1) * Math.sin(tickA);
                    const tLen = t % 3 === 0 ? 6 : 3;
                    const t2x = cx + (R_CENTER - 1 - tLen) * Math.cos(tickA);
                    const t2y = cy + (R_CENTER - 1 - tLen) * Math.sin(tickA);
                    s += `<line x1="${t1x}" y1="${t1y}" x2="${t2x}" y2="${t2y}" stroke="#3a3a5a" stroke-width="${t % 3 === 0 ? 1 : 0.5}"/>`;
                }

                s += `<text x="${cx}" y="${cy - 28}" fill="${h.planet.hex}" font-size="32" text-anchor="middle" dominant-baseline="central" font-weight="bold" filter="url(#softGlow)">${h.planet.symbol}</text>`;
                s += `<text x="${cx}" y="${cy + 2}" fill="#ddd6f0" font-size="12" text-anchor="middle" dominant-baseline="central" font-weight="600" font-family="Cinzel,serif">Godzina ${h.planet.name}</text>`;
                s += `<text x="${cx}" y="${cy + 18}" fill="#7a7498" font-size="9.5" text-anchor="middle" dominant-baseline="central">${h.isDay ? 'Dzienna' : 'Nocna'} ${h.isDay ? h.num : h.num-12}/12 \u00b7 ${fmtTime(h.start)}\u2013${fmtTime(h.end)}</text>`;
                s += `<text x="${cx}" y="${cy + 33}" fill="#7a7498" font-size="8.5" text-anchor="middle" dominant-baseline="central">jeszcze ${remaining} min</text>`;
            } else if (!hours) {
                s += `<text x="${cx}" y="${cy - 5}" fill="#7a7498" font-size="11" text-anchor="middle" dominant-baseline="central">Ustaw lokalizacje</text>`;
                s += `<text x="${cx}" y="${cy + 10}" fill="#7a7498" font-size="9" text-anchor="middle" dominant-baseline="central">aby zobaczyc godziny</text>`;
            } else {
                s += `<text x="${cx}" y="${cy}" fill="#7a7498" font-size="10" text-anchor="middle" dominant-baseline="central">poza zakresem godzin</text>`;
            }

            // ===== LABELS =====
            if (sunrise && sunset) {
                s += `<text x="${cx}" y="16" fill="#f0c040" font-size="10" text-anchor="middle" font-weight="600" font-family="Cinzel,serif">\u2600 ${fmtTime(sunrise)}</text>`;
                s += `<text x="${cx}" y="${H - 6}" fill="#6080b0" font-size="10" text-anchor="middle" font-weight="600" font-family="Cinzel,serif">\u263D ${fmtTime(sunset)}</text>`;
            }

            // Sun longitude display
            s += `<text x="${cx}" y="${cy + 50}" fill="#c8a84e66" font-size="8" text-anchor="middle">\u2609 ${sunLon.toFixed(1)}\u00b0</text>`;

            s += `</svg>`;
            return s;
        }

        // ===== RENDERING =====

        function renderToday() {
            const zd = gregorianToZodiac(todayUTC, userLat, userLng);
            const meta = ZODIAC[zd.month - 1];
            let sunInfo = '';
            let currentHourHTML = '';

            if (userLat !== null) {
                const st = getSunTimes(new Date(), userLat, userLng);
                if (st.polarDay) {
                    polarState = 'day';
                    sunInfo = `<div class="sun-times-row"><span>Dzien polarny</span></div>`;
                } else if (st.polarNight) {
                    polarState = 'night';
                    sunInfo = `<div class="sun-times-row"><span>Noc polarna</span></div>`;
                } else {
                    polarState = null;
                    sunInfo = `<div class="sun-times-row">
                        <span>\u2600 Wschod: ${fmtTime(st.sunrise)}</span>
                        <span>\u263D Zachod: ${fmtTime(st.sunset)}</span>
                    </div>`;
                }
            }

            // Sun longitude
            const jd = julianDay(nowLocal.getUTCFullYear(), nowLocal.getUTCMonth() + 1, nowLocal.getUTCDate(),
                nowLocal.getUTCHours() + nowLocal.getUTCMinutes() / 60);
            const sunLon = sunLongitude(jd);

            document.getElementById('today-panel').innerHTML = `
                <span class="sign-symbol">${zd.sign.symbol}</span>
                <div class="zodiac-date">${zd.day} ${zd.sign.name}, ${fmtAmarethYear(zd.year)}</div>
                <div class="gregorian-date">${todayUTC.toISOString().slice(0, 10)}</div>
                <div class="sign-badges">
                    <span class="badge badge-${meta.element}">${ELEMENT_LABELS[meta.element]}</span>
                    <span class="badge badge-${meta.element}">${MODALITY_LABELS[meta.modality]}</span>
                </div>
                <div class="sun-position">\u2609 Slonce: ${sunLon.toFixed(1)}\u00b0 w ${zd.sign.name}</div>
                ${sunInfo}
            `;

            renderPolarWarning();
            renderWheel();
        }

        function renderPolarWarning() {
            const el = document.getElementById('polar-warning');
            if (!polarState) { el.style.display = 'none'; return; }
            el.style.display = 'block';
            const isPolarDay = polarState === 'day';
            el.innerHTML = `<div class="polar-warning">
                <div class="pw-icon">${isPolarDay ? '\u2600\uFE0F' : '\uD83C\uDF11'}</div>
                <div class="pw-title">${isPolarDay ? 'Dzien polarny' : 'Noc polarna'}</div>
                <div class="pw-detail">
                    ${isPolarDay ? 'Brak zachodu Slonca' : 'Brak wschodu Slonca'} w tej lokalizacji.<br>
                    Godziny planetarne sa niedostepne.
                </div>
            </div>`;
        }

        function renderWheel() {
            const container = document.getElementById('wheel-container');
            if (userLat === null || polarState) {
                container.innerHTML = buildAstroWheel(null, -1, null, null, 0, 0);
                return;
            }

            const now = new Date();
            const st = getSunTimes(now, userLat, userLng);
            if (st.polarDay || st.polarNight) {
                container.innerHTML = buildAstroWheel(null, -1, null, null, 0, 0);
                return;
            }

            const nowMs = now.getTime();
            if (nowMs < st.sunrise.getTime()) {
                const yesterday = new Date(now.getTime() - DAY_MS);
                const stYesterday = getSunTimes(yesterday, userLat, userLng);
                if (stYesterday.polarDay || stYesterday.polarNight) {
                    container.innerHTML = buildAstroWheel(null, -1, null, null, 0, 0);
                    return;
                }
                const ph = getPlanetaryHours(stYesterday.sunrise, stYesterday.sunset, st.sunrise, yesterday.getDay());
                let ci = -1;
                for (let i = 0; i < ph.hours.length; i++) {
                    if (nowMs >= ph.hours[i].start.getTime() && nowMs < ph.hours[i].end.getTime()) { ci = i; break; }
                }
                container.innerHTML = buildAstroWheel(ph.hours, ci, stYesterday.sunrise, stYesterday.sunset, ph.dayHourMin, ph.nightHourMin);
                return;
            }

            const tomorrow = new Date(now.getTime() + DAY_MS);
            const stTomorrow = getSunTimes(tomorrow, userLat, userLng);
            const nextSunrise = stTomorrow.polarDay || stTomorrow.polarNight ? null : stTomorrow.sunrise;
            if (!nextSunrise) {
                container.innerHTML = buildAstroWheel(null, -1, null, null, 0, 0);
                return;
            }

            const ph = getPlanetaryHours(st.sunrise, st.sunset, nextSunrise, now.getDay());
            let ci = -1;
            for (let i = 0; i < ph.hours.length; i++) {
                if (nowMs >= ph.hours[i].start.getTime() && nowMs < ph.hours[i].end.getTime()) { ci = i; break; }
            }
            container.innerHTML = buildAstroWheel(ph.hours, ci, st.sunrise, st.sunset, ph.dayHourMin, ph.nightHourMin);
        }

        function renderYear(year) {
            const ingresses = getIngresses(year);
            const starts = getMonthStartDates(year, userLat, userLng);
            const todayZodiac = gregorianToZodiac(todayUTC, userLat, userLng);
            document.getElementById('year-label').textContent = fmtAmarethYear(year);
            let totalDays = 0;
            const monthsHTML = ingresses.map((ing, i) => {
                const days = getMonthDays(year, i, userLat, userLng);
                totalDays += days;
                const isCurrent = todayZodiac.year === year && todayZodiac.month === i + 1;
                const startDate = new Date(starts[i]);
                const startDow = (startDate.getUTCDay() + 6) % 7;
                const meta = ZODIAC[i];

                let daysHTML = DAY_NAMES.map(d => `<div class="day-label">${d}</div>`).join('');
                for (let e = 0; e < startDow; e++) daysHTML += '<div class="day-cell empty"></div>';
                for (let d = 1; d <= days; d++) {
                    const isToday = isCurrent && d === todayZodiac.day;
                    daysHTML += `<div class="day-cell${isToday ? ' today' : ''}">${d}</div>`;
                }
                const dateStr = `${startDate.getUTCDate()} ${startDate.toLocaleString('pl', {month:'short', timeZone:'UTC'})} ${startDate.getUTCFullYear()}`;
                return `<div class="month-card ${meta.element}${isCurrent ? ' current' : ''}">
                    <div class="month-header">
                        <span class="symbol">${ing.symbol}</span>
                        <span class="name">${ing.name}</span>
                        <span class="days-badge">${days} dni</span>
                    </div>
                    <div class="month-info"><span>od ${dateStr}</span><span>${ing.lon}\u00b0\u2013${ing.lon+30}\u00b0</span></div>
                    <div class="days-grid">${daysHTML}</div>
                </div>`;
            }).join('');
            document.getElementById('months-grid').innerHTML = monthsHTML;
            document.getElementById('year-summary').textContent = `Suma dni: ${totalDays}`;
        }

        // ===== LOCATION HANDLING =====

        function updateThemeLinks() {
            const link = document.getElementById('classic-link');
            if (link && userLat !== null) link.href = `index.html?lat=${userLat}&lng=${userLng}`;
        }

        function setLocation(lat, lng, label) {
            userLat = lat;
            userLng = lng;
            document.getElementById('loc-status').textContent = `${label} (${lat.toFixed(2)}, ${lng.toFixed(2)})`;
            document.getElementById('lat-input').value = lat.toFixed(2);
            document.getElementById('lng-input').value = lng.toFixed(2);
            currentYear = gregorianToZodiac(todayUTC, userLat, userLng).year;
            renderToday();
            renderYear(currentYear);
            updateThemeLinks();
        }

        window.requestGeolocation = function() {
            if (!navigator.geolocation) {
                document.getElementById('loc-status').textContent = 'Geolokalizacja niedostepna w tej przegladarce';
                return;
            }
            document.getElementById('loc-status').textContent = 'Pobieram lokalizacje...';
            navigator.geolocation.getCurrentPosition(
                (pos) => setLocation(pos.coords.latitude, pos.coords.longitude, 'Twoja lokalizacja'),
                (err) => { document.getElementById('loc-status').textContent = 'Nie udalo sie pobrac lokalizacji: ' + err.message; }
            );
        };

        window.selectCity = function(val) {
            if (!val) return;
            const [lat, lng] = val.split(',').map(Number);
            const sel = document.getElementById('city-select');
            const label = sel.options[sel.selectedIndex].text;
            setLocation(lat, lng, label);
        };

        window.setManualLocation = function() {
            const lat = parseFloat(document.getElementById('lat-input').value);
            const lng = parseFloat(document.getElementById('lng-input').value);
            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                document.getElementById('loc-status').textContent = 'Nieprawidlowe wspolrzedne';
                return;
            }
            setLocation(lat, lng, 'Reczna lokalizacja');
        };

        window.changeYear = function(delta) { currentYear += delta; renderYear(currentYear); };

        window.convertDate = function(value) {
            if (!value) return;
            const parts = value.split('-');
            const date = new Date(Date.UTC(+parts[0], +parts[1] - 1, +parts[2]));
            const zd = gregorianToZodiac(date, userLat, userLng);
            const locNote = userLat !== null ? '' : ' (UTC, bez lokalizacji)';
            document.getElementById('converter-result').textContent =
                `${zd.day} ${zd.sign.name} ${zd.sign.symbol} (${zd.sign.latin}), ${fmtAmarethYear(zd.year)}${locNote}`;
        };

        // ===== INIT =====
        document.getElementById('loc-status').textContent = `Torun (${userLat.toFixed(2)}, ${userLng.toFixed(2)})`;
        document.getElementById('lat-input').value = userLat.toFixed(2);
        document.getElementById('lng-input').value = userLng.toFixed(2);
        document.getElementById('city-select').value = '53.01,18.60';
        renderToday();
        renderYear(currentYear);
        document.getElementById('converter-input').value = todayUTC.toISOString().slice(0, 10);
        window.convertDate(todayUTC.toISOString().slice(0, 10));
        updateThemeLinks();

        // Auto-refresh wheel every 10s for visible hand movement
        setInterval(() => {
            if (userLat !== null) renderWheel();
        }, 10000);
    </script>
</body>
</html>
